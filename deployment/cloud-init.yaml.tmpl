#cloud-config
package_update: true
package_upgrade: true

timezone: UTC

users:
  - name: ubuntu
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    ssh_authorized_keys:
      - ${SSH_PUBLIC_KEY}

disable_root: true
ssh_pwauth: false

packages:
  - curl
  - git
  - ca-certificates
  - gnupg
  - lsb-release
  - ufw
  - fail2ban

runcmd:
  # Firewall - Allow SSH, HTTP, HTTPS
  - ufw allow OpenSSH
  - ufw allow 80/tcp
  - ufw allow 443/tcp
  - ufw --force enable

  # Mount Hetzner Volume at /mnt/data (if attached)
  # Volume must be created in Hetzner panel and attached to this server
  # Device path: /dev/disk/by-id/scsi-0HC_Volume_${HETZNER_VOLUME_ID}
  - |
    VOLUME_DEVICE="/dev/disk/by-id/scsi-0HC_Volume_${HETZNER_VOLUME_ID}"
    MOUNT_POINT="/mnt/data"

    if [ -n "${HETZNER_VOLUME_ID}" ] && [ -e "$VOLUME_DEVICE" ]; then
      echo "Hetzner volume detected: $VOLUME_DEVICE"

      # Check if volume has a filesystem, format if not
      if ! blkid "$VOLUME_DEVICE" | grep -q 'TYPE='; then
        echo "Formatting volume with ext4..."
        mkfs.ext4 -F "$VOLUME_DEVICE"
      fi

      # Create mount point
      mkdir -p "$MOUNT_POINT"

      # Mount the volume
      mount -o discard,defaults "$VOLUME_DEVICE" "$MOUNT_POINT"

      # Add to fstab for persistence across reboots
      if ! grep -q "$VOLUME_DEVICE" /etc/fstab; then
        echo "$VOLUME_DEVICE $MOUNT_POINT ext4 discard,nofail,defaults 0 0" >> /etc/fstab
      fi

      # Create directories for Postgres and Redis data
      mkdir -p "$MOUNT_POINT/postgres"
      mkdir -p "$MOUNT_POINT/redis"

      # Set permissions (postgres runs as uid 999, redis as uid 999)
      chown -R 999:999 "$MOUNT_POINT/postgres"
      chown -R 999:999 "$MOUNT_POINT/redis"

      echo "Volume mounted successfully at $MOUNT_POINT"
    else
      echo "No Hetzner volume configured or volume not attached (HETZNER_VOLUME_ID=${HETZNER_VOLUME_ID})"
      echo "Using local storage instead"
      mkdir -p /mnt/data/postgres /mnt/data/redis
    fi

  # Docker
  - curl -fsSL https://get.docker.com | sh
  - usermod -aG docker ubuntu
  - systemctl enable docker
  - systemctl start docker

  # Docker Compose v2
  - mkdir -p /usr/local/lib/docker/cli-plugins
  - curl -SL https://github.com/docker/compose/releases/download/v2.27.0/docker-compose-linux-x86_64 -o /usr/local/lib/docker/cli-plugins/docker-compose
  - chmod +x /usr/local/lib/docker/cli-plugins/docker-compose

  # Create app directory
  - mkdir -p /home/ubuntu/src
  - chown -R ubuntu:ubuntu /home/ubuntu/src

final_message: "Provisioning complete. Server ready."
