summary: WhatsApp webhook processor
description: ''
value:
  modules:
    - id: step1
      value:
        type: script
        input_transforms:
          db_resource:
            type: static
            value: f/development/business_layer_db_postgreSQL
          message_id:
            type: javascript
            expr: flow_input.message_id
          user_name:
            type: javascript
            expr: flow_input.user_name
          user_phone:
            type: javascript
            expr: flow_input.user_phone
          whatsapp_phone_id:
            type: javascript
            expr: flow_input.phone_number_id
        is_trigger: false
        path: f/development/1_whatsapp_context_loading
    - id: step2
      value:
        type: script
        input_transforms:
          context_payload:
            type: javascript
            expr: results.step1
          db_resource:
            type: static
            value: f/development/business_layer_db_postgreSQL
          default_provider:
            type: static
            value: google
          google_api_key:
            type: static
            value: <function call>
          openai_api_key:
            type: static
            value: ''
          user_message:
            type: javascript
            expr: flow_input.message_body
        is_trigger: false
        path: f/development/2_whatsapp_llm_processing
    - id: step3
      summary: Send reply to WhatsApp via Meta API
      value:
        type: script
        input_transforms:
          context_payload:
            type: javascript
            expr: results.step1
          llm_result:
            type: javascript
            expr: results.step2
          phone_number_id:
            type: javascript
            expr: flow_input.phone_number_id
        is_trigger: false
        path: f/development/3_1_send_reply_to_whatsapp
    - id: step4
      summary: Save chat history to database
      value:
        type: script
        input_transforms:
          context_payload:
            type: javascript
            expr: results.step1
          db_resource:
            type: static
            value: f/development/business_layer_db_postgreSQL
          llm_result:
            type: javascript
            expr: results.step2
          send_result:
            type: javascript
            expr: results.step3
          user_message:
            type: javascript
            expr: flow_input.message_body
        is_trigger: false
        path: f/development/4_save_chat_history
      skip_if:
        expr: '!results.step3.success'
    - id: a
      value:
        type: script
        input_transforms:
          context_payload:
            type: javascript
            expr: results.step1
          db_resource:
            type: static
            value: f/development/business_layer_db_postgreSQL
          llm_result:
            type: javascript
            expr: results.step2
          send_result:
            type: javascript
            expr: results.step3
          webhook_event_id:
            type: javascript
            expr: ''
        is_trigger: false
        path: f/development/5_log_usage
    - id: step6
      summary: 'Alert admin on LLM errors (rate limits, quota exceeded, etc.)'
      value:
        type: script
        input_transforms:
          chatbot_id:
            type: javascript
            expr: results.step1.chatbot.id
          db_resource:
            type: static
            value: f/development/business_layer_db_postgreSQL
          error_message:
            type: javascript
            expr: results.step2.usage_info.error
          error_name:
            type: javascript
            expr: >-
              results.step2.usage_info.is_limit_error ? 'RATE_LIMIT_ERROR' :
              'LLM_ERROR'
          slack_webhook_url:
            type: static
            value: <function call>
          step_id:
            type: static
            value: step2
          user_phone:
            type: javascript
            expr: flow_input.user_phone
        is_trigger: false
        path: f/development/utils/alert_on_failure
      skip_if:
        expr: '!results.step2.usage_info || !results.step2.usage_info.error'
  failure_module:
    id: failure
    value:
      type: script
      input_transforms:
        chatbot_id:
          type: javascript
          expr: flow_input.phone_number_id || 'unknown'
        db_resource:
          type: static
        error_message:
          type: javascript
          expr: error.message
        error_name:
          type: javascript
          expr: error.name
        slack_webhook_url:
          type: static
        step_id:
          type: javascript
          expr: error.step_id
        user_phone:
          type: javascript
          expr: flow_input.user_phone || 'unknown'
      path: f/development/utils/alert_on_failure
schema:
  $schema: 'https://json-schema.org/draft/2020-12/schema'
  type: object
  order:
    - phone_number_id
    - user_phone
    - message_body
    - user_name
  properties:
    message_body:
      type: string
      description: ''
      default: ''
    phone_number_id:
      type: string
      description: ''
      default: ''
    user_name:
      type: string
      description: ''
      default: ''
    user_phone:
      type: string
      description: ''
      default: ''
  required: []
