summary: WhatsApp webhook processor
description: ''
value:
  modules:
    - id: step1
      value:
        type: script
        input_transforms:
          db_resource:
            type: static
            value: f/development/business_layer_db_postgreSQL
          message_id:
            type: javascript
            expr: flow_input.message_id
          user_name:
            type: javascript
            expr: flow_input.user_name
          user_phone:
            type: javascript
            expr: flow_input.user_phone
          whatsapp_phone_id:
            type: javascript
            expr: flow_input.phone_number_id
        is_trigger: false
        path: f/development/1_whatsapp_context_loading
    - id: step2
      value:
        type: script
        input_transforms:
          context_payload:
            type: javascript
            expr: results.step1
          default_provider:
            type: static
            value: google
          google_api_key:
            type: static
            value: <function call>
          openai_api_key:
            type: static
            value: ''
          user_message:
            type: javascript
            expr: flow_input.message_body
        is_trigger: false
        path: f/development/2_whatsapp_llm_processing
    - id: step3
      summary: Send reply to WhatsApp via Meta API
      value:
        type: script
        input_transforms:
          context_payload:
            type: javascript
            expr: results.step1
          llm_result:
            type: javascript
            expr: results.step2
          phone_number_id:
            type: javascript
            expr: flow_input.phone_number_id
        is_trigger: false
        path: f/development/3_1_send_reply_to_whatsapp
    - id: step4
      summary: Save chat history to database
      skip_if:
        expr: '!results.step3.success'
      value:
        type: script
        input_transforms:
          context_payload:
            type: javascript
            expr: results.step1
          db_resource:
            type: static
            value: f/development/business_layer_db_postgreSQL
          llm_result:
            type: javascript
            expr: results.step2
          user_message:
            type: javascript
            expr: flow_input.message_body
          send_result:
            type: javascript
            expr: results.step3
        is_trigger: false
        path: f/development/4__save_chat_history
    - id: step5
      summary: Log usage for billing and analytics
      skip_if:
        expr: '!results.step3.success'
      value:
        type: script
        input_transforms:
          context_payload:
            type: javascript
            expr: results.step1
          llm_result:
            type: javascript
            expr: results.step2
          db_resource:
            type: static
            value: f/development/business_layer_db_postgreSQL
          send_result:
            type: javascript
            expr: results.step3
        is_trigger: false
        path: f/development/5__log_usage
    - id: step6
      summary: Alert admin on LLM errors (rate limits, quota exceeded, etc.)
      skip_if:
        expr: '!results.step2.usage_info || !results.step2.usage_info.error'
      value:
        type: script
        input_transforms:
          error_message:
            type: javascript
            expr: results.step2.usage_info.error
          step_id:
            type: static
            value: step2
          error_name:
            type: javascript
            expr: "results.step2.usage_info.is_limit_error ? 'RATE_LIMIT_ERROR' : 'LLM_ERROR'"
          chatbot_id:
            type: javascript
            expr: results.step1.chatbot.id
          user_phone:
            type: javascript
            expr: flow_input.user_phone
          db_resource:
            type: static
            value: f/development/business_layer_db_postgreSQL
        is_trigger: false
        path: f/development/utils/alert_on_failure
  failure_module:
    id: failure
    value:
      type: script
      path: f/development/utils/alert_on_failure
      input_transforms:
        error_message:
          type: javascript
          expr: error.message
        step_id:
          type: javascript
          expr: error.step_id
        error_name:
          type: javascript
          expr: error.name
        chatbot_id:
          type: javascript
          expr: flow_input.phone_number_id || 'unknown'
        user_phone:
          type: javascript
          expr: flow_input.user_phone || 'unknown'
schema:
  $schema: 'https://json-schema.org/draft/2020-12/schema'
  type: object
  order:
    - phone_number_id
    - user_phone
    - message_body
    - user_name
  properties:
    message_body:
      type: string
      description: ''
      default: ''
    phone_number_id:
      type: string
      description: ''
      default: ''
    user_name:
      type: string
      description: ''
      default: ''
    user_phone:
      type: string
      description: ''
      default: ''
  required: []
