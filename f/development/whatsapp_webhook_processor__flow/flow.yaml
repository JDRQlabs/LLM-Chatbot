summary: WhatsApp webhook processor
description: ''
value:
  modules:
    - id: step1
      value:
        type: script
        input_transforms:
          db_resource:
            type: static
            value: f/development/business_layer_db_postgreSQL
          user_name:
            type: javascript
            expr: flow_input.user_name
          user_phone:
            type: javascript
            expr: flow_input.user_phone
          whatsapp_phone_id:
            type: javascript
            expr: flow_input.phone_number_id
        is_trigger: false
        path: f/development/1_whatsapp_context_loading
    - id: step2
      value:
        type: script
        input_transforms:
          context_payload:
            type: javascript
            expr: results.step1
          default_provider:
            type: static
            value: google
          google_api_key:
            type: static
            value: <function call>
          openai_api_key:
            type: static
            value: ''
          user_message:
            type: javascript
            expr: flow_input.message_body
        is_trigger: false
        path: f/development/2_whatsapp_llm_processing
    - id: h
      summary: ''
      value:
        type: branchall
        branches:
          - modules:
              - id: step3a
                value:
                  type: script
                  input_transforms:
                    context_payload:
                      type: javascript
                      expr: results.step1
                    llm_result:
                      type: javascript
                      expr: results.step2
                    phone_number_id:
                      type: javascript
                      expr: flow_input.phone_number_id
                  is_trigger: false
                  path: f/development/3_1_send_reply_to_whatsapp
            expr: ''
            parallel: true
            skip_failure: false
          - summary: ''
            modules:
              - id: step3b
                value:
                  type: script
                  input_transforms:
                    context_payload:
                      type: javascript
                      expr: results.step1
                    db_resource:
                      type: static
                      value: f/development/business_layer_db_postgreSQL
                    llm_result:
                      type: javascript
                      expr: results.step2
                    user_message:
                      type: javascript
                      expr: flow_input.message_body
                  is_trigger: false
                  path: f/development/3_2_save_chat_history
            expr: 'false'
            parallel: true
            skip_failure: false
          - summary: Log usage for billing and analytics
            modules:
              - id: step3c
                value:
                  type: script
                  input_transforms:
                    context_payload:
                      type: javascript
                      expr: results.step1
                    llm_result:
                      type: javascript
                      expr: results.step2
                    db_resource:
                      type: static
                      value: f/development/business_layer_db_postgreSQL
                  is_trigger: false
                  path: f/development/3_3_log_usage
            expr: 'false'
            parallel: true
            skip_failure: false
        parallel: true
  failure_module:
    id: failure
    value:
      type: rawscript
      content: |
        import os


        def main(message: str, name: str, step_id: str):
            flow_id = os.environ.get("WM_ROOT_FLOW_JOB_ID")
            print("message", message)
            print("name", name)
            print("step_id", step_id)
            return {
                "message": message,
                "flow_id": flow_id,
                "step_id": step_id,
                "recover": False,
            }
      input_transforms:
        name:
          type: javascript
          expr: error.name
        message:
          type: javascript
          expr: error.message
        step_id:
          type: javascript
          expr: error.step_id
      lock: |
        # py: 3.12
      language: python3
schema:
  $schema: 'https://json-schema.org/draft/2020-12/schema'
  type: object
  order:
    - phone_number_id
    - user_phone
    - message_body
    - user_name
  properties:
    message_body:
      type: string
      description: ''
      default: ''
    phone_number_id:
      type: string
      description: ''
      default: ''
    user_name:
      type: string
      description: ''
      default: ''
    user_phone:
      type: string
      description: ''
      default: ''
  required: []
