# Production Caddyfile for WhatsApp Chatbot Platform
#
# Subdomain-based routing with automatic HTTPS via Let's Encrypt.
# Set DOMAIN environment variable to your base domain (e.g., jdsoftwarelabs.com)
#
# Subdomains:
#   - api.{DOMAIN}      → Backend API + WhatsApp webhooks
#   - windmill.{DOMAIN} → Windmill admin dashboard
#   - {DOMAIN} (root)   → Reserved for future frontend

# Global options
{
    # Email for Let's Encrypt notifications
    email {$ADMIN_EMAIL:admin@example.com}

    # Uncomment for staging certificates during testing
    # acme_ca https://acme-staging-v02.api.letsencrypt.org/directory
}

# =============================================================================
# HTTP-only fallback for IP-based access (testing/development)
# =============================================================================
:80 {
    header {
        X-Frame-Options "DENY"
        X-Content-Type-Options "nosniff"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        -Server
    }

    # WhatsApp Webhook endpoint
    handle /webhook* {
        uri strip_prefix /webhook
        reverse_proxy webhook-ingress:3000
    }

    # Management API
    handle /api/* {
        uri strip_prefix /api
        reverse_proxy whatsapp_chatbot_api:4000
    }

    # Health check
    handle /health {
        respond "OK" 200
    }

    handle {
        respond "Not Found" 404
    }

    log {
        output file /data/access-http.log {
            roll_size 10mb
            roll_keep 5
        }
        format json
    }
}

# =============================================================================
# API Subdomain (api.jdsoftwarelabs.com)
# Handles both Management API and WhatsApp webhooks
# =============================================================================
api.{$DOMAIN} {
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Frame-Options "DENY"
        X-Content-Type-Options "nosniff"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        -Server
    }

    # WhatsApp Webhook endpoint
    # Meta will call: https://api.jdsoftwarelabs.com/webhook
    handle /webhook* {
        uri strip_prefix /webhook
        reverse_proxy webhook-ingress:3000
    }

    # Management API
    # Frontend will call: https://api.jdsoftwarelabs.com/api/*
    handle /api/* {
        uri strip_prefix /api
        reverse_proxy whatsapp_chatbot_api:4000
    }

    # Health check
    handle /health {
        respond "OK" 200
    }

    # Default
    handle {
        respond "Not Found" 404
    }

    log {
        output file /data/access-api.log {
            roll_size 10mb
            roll_keep 5
        }
        format json
    }
}

# =============================================================================
# Windmill Subdomain (windmill.jdsoftwarelabs.com)
# Admin dashboard with basic auth protection
# =============================================================================
windmill.{$DOMAIN} {
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains"
        X-Content-Type-Options "nosniff"
        -Server
    }

    # Basic auth for Windmill admin access
    # Credentials: admin / windmill-admin-2025
    # To change: docker exec caddy caddy hash-password --plaintext 'new-password'
    basic_auth {
        admin $2a$14$Zkx5U/hq6t8KoEnKdNzy0eTxXjYj7Nf6zJmXoXdL1UpqYP9lPvnOe
    }

    reverse_proxy windmill_server:8000

    log {
        output file /data/access-windmill.log {
            roll_size 10mb
            roll_keep 5
        }
        format json
    }
}

# =============================================================================
# Rate limiting notes
# =============================================================================
# Rate limiting is implemented at the application level using
# express-rate-limit in api-server/middleware/rateLimit.js
#
# Current limits:
# - Auth endpoints (login/register): 5 requests per 15 minutes
# - General API: 100 requests per minute per user
# - Knowledge uploads: 10 uploads per hour per organization
# - Webhooks: 1000 requests per minute (for WhatsApp)
